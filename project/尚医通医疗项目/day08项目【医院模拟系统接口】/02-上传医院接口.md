# 一、上传医院接口

参考《尚医通API接口文档.doc》业务接口4.1上传医院

医院编号是平台分配的，全局唯一，上传医院接口可以多次调用，如果存在相同编号的为更新操作

## 1、数据分析

```json
{
    "hoscode": "1000_0",
    "hosname": "北京协和医院",
    "hostype": "1",
    "provinceCode": "110000",
    "cityCode": "110100",
    "districtCode": "110102",
    "address": "大望路",
    "intro": "北京协和医院是集医疗、教学、科研于一体的大型三级甲等综合医院，是国家卫生计生委...目标而继续努力。",
    "route": "东院区乘车路线：106、...更多乘车路线详见须知。",
    "logoData": "iVBORw0KGgoAAAA...NSUhEUg==",
    "bookingRule": {
    "cycle": "1",
    "releaseTime": "08:30",
    "stopTime": "11:30",
    "quitDay": "-1",
    "quitTime": "15:30",
    "rule": [
        "西院区预约号取号地点：西院区门诊楼一层大厅挂号窗口取号",
        "东院区预约号取号地点：东院区老门诊楼一层大厅挂号窗口或新门诊楼各楼层挂号/收费窗口取号"
        ]
  }
}
```

说明：

1，数据分为医院基本信息与预约规则信息

2，医院logo转换为base64字符串

3，预约规则信息属于医院基本信息的一个属性

4，预约规则rule，以数组形式传递

5，数据传递过来我们还要验证签名，只允许平台开通的医院可以上传数据，保证数据安全性

## 2、添加service接口

在HospService添加

```java
/**
 * 上传医院信息
 * @param paramMap
*/
void save(Map<String, Object> paramMap);
```

**在HospitalServiceImpl类添加实现**

```java
@Override
public void save(Map<String, Object> paramMap) {
   Hospital hospital = JSONObject.parseObject(JSONObject.toJSONString(paramMap),Hospital.class);
   //判断是否存在
    Hospital targetHospital = hospitalRepository.getHospitalByHoscode(hospital.getHoscode());
    if(null != targetHospital) {
        hospital.setStatus(targetHospital.getStatus());
        hospital.setCreateTime(targetHospital.getCreateTime());
        hospital.setUpdateTime(new Date());
        hospital.setIsDeleted(0);
        hospital.setId(targetHospital.getId()); //根据id更新
    	hospitalRepository.save(hospital);
   } else {
    	//0：未上线 1：已上线
    	hospital.setStatus(0);
        hospital.setCreateTime(new Date());
        hospital.setUpdateTime(new Date());
        hospital.setIsDeleted(0);
    	hospitalRepository.save(hospital);
   }
}
```

## 3、添加repository接口

在HospitalRepository类添加接口

```java
Hospital getHospitalByHoscode(String hoscode);
```

## 4、添加controller接口

```java
@ApiOperation(value = "上传医院")
@PostMapping("saveHospital")
public Result saveHospital(HttpServletRequest request) {
    Map<String, Object> paramMap = HttpRequestHelper.switchMap(request.getParameterMap());

	hospitalService.save(paramMap);
	return Result.ok();
}
```

## 5、添加帮助类

```java
public class HttpRequestHelper {
	public static Map<String, Object> switchMap(Map<String, String[]> paramMap) {
        Map<String, Object> resultMap = new HashMap<>();
        for (Map.Entry<String, String[]> param : paramMap.entrySet()) {
            resultMap.put(param.getKey(), param.getValue()[0]);
        }
        return resultMap;
    }
}
```

## 6、参数签名

添加工具类MD5

```java
public final class MD5 {

    public static String encrypt(String strSrc) {
        try {
            char hexChars[] = { '0', '1', '2', '3', '4', '5', '6', '7', '8',
                    '9', 'a', 'b', 'c', 'd', 'e', 'f' };
            byte[] bytes = strSrc.getBytes();
            MessageDigest md = MessageDigest.getInstance("MD5");
            md.update(bytes);
            bytes = md.digest();
            int j = bytes.length;
            char[] chars = new char[j * 2];
            int k = 0;
            for (int i = 0; i < bytes.length; i++) {
                byte b = bytes[i];
                chars[k++] = hexChars[b >>> 4 & 0xf];
                chars[k++] = hexChars[b & 0xf];
            }
            return new String(chars);
        } catch (NoSuchAlgorithmException e) {
            e.printStackTrace();
            throw new RuntimeException("MD5加密出错！！+" + e);
        }
    }
}
```

## 7、在HospitalSetService类添加方法

```java
/**
 * 获取签名key
 * @param hoscode
 * @return
 */
String getSignKey(String hoscode);

@Override
public String getSignKey(String hoscode) {
    HospitalSet hospitalSet = this.getByHoscode(hoscode);
    if(null == hospitalSet) {
        throw new YyghException(20001,"失败");
    }
    return hospitalSet.getSignKey();
}

/**
 * 根据hoscode获取医院设置
 * @param hoscode
 * @return
 */
private HospitalSet getByHoscode(String hoscode) {
    return baseMapper.selectOne(new QueryWrapper<HospitalSet>().eq("hoscode", hoscode));
}
```

## 8、修改ApiController代码

```java
@Api(tags = "医院管理API接口")
@RestController
@RequestMapping("/api/hosp")
public class ApiController {

    @Autowired
    private HospitalService hospitalService;

    @Autowired
    private HospitalSetService hospitalSetService;

    @ApiOperation(value = "上传医院")
    @PostMapping("saveHospital")
    public Result saveHospital(HttpServletRequest request) {
        Map<String, Object> paramMap = HttpRequestHelper.switchMap(request.getParameterMap());

        //必须参数校验 略
        String hoscode = (String)paramMap.get("hoscode");
        if(StringUtils.isEmpty(hoscode)) {
            throw new YyghException(20001,"失败");
        }
        //签名校验
        //1 获取医院系统传递过来的签名,签名进行MD5加密
        String hospSign = (String)paramMap.get("sign");
        //2 根据传递过来医院编码，查询数据库，查询签名
        String signKey = hospitalSetService.getSignKey(hoscode);
        //3 把数据库查询签名进行MD5加密
        String signKeyMd5 = MD5.encrypt(signKey);
        //4 判断签名是否一致
        if(!hospSign.equals(signKeyMd5)) {
            throw new YyghException(20001,"校验失败");
        }

        //传输过程中“+”转换为了“ ”，因此我们要转换回来
        String logoData = (String)paramMap.get("logoData");
        logoData = logoData.replaceAll(" ","+");
        paramMap.put("logoData",logoData);

        hospitalService.save(paramMap);
        return Result.ok();
    }
}
```
